{% set pageTitle = "Royal Mail barcode reference" %}

{% extends "includes/layout.html" %}

{% block beforeContent %}
  <div class="govuk-phase-banner">
    <p class="govuk-phase-banner__content">
      <strong class="govuk-tag govuk-phase-banner__content__tag">
        beta
      </strong>
      <span class="govuk-phase-banner__text">
        This is a new service – your <a class="govuk-link" href="#">feedback</a> will help us to improve it.
      </span>
    </p>
  </div>

  <a class="govuk-back-link" href="#">Back</a>
{% endblock %}

{% block content %}
  {% include "includes/gtm-noscript.html" %}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

      <form action="/IBT/antigen/feature-design/barcode-scanner/test-kit-barcode" method="post">

        <div id="content-1">
          <div class="govuk-form-group">
            <fieldset class="govuk-fieldset">
              <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
                <h1 class="govuk-heading-l govuk-!-margin-bottom-6">
                  {{ pageTitle }}
                </h1>
              </legend>
              <p class="govuk-body">
                You'll find it on the right-hand side of the label on your return box. Do not scan the QR code, which is on the left-hand side of the label.
              </p>
              <div class="govuk-!-margin-top-5">
                <img src="/public/images/royal-mail-barcode.png" class="responsive-image" alt="Illustration of a royal mail barcode showing the position on return box. It is on the right-hand side of the label on your return box."/>
              </div>
            </fieldset>
          </div>
          <button id="scan-barcode" class="govuk-button" data-toggle="modal" data-target="modal-with-data-attributes">Scan barcode</button>
          <button id="manual-entry" class="govuk-button govuk-button--secondary" data-module="govuk-button">Enter barcode manually</button>
        </div>

        <div id="content-2" style="display: none;">
          <div class="govuk-form-group">
            <fieldset class="govuk-fieldset">
              <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
                <h1 class="govuk-heading-l govuk-!-margin-bottom-6">
                  {{ pageTitle }}
                </h1>
              </legend>
              <p class="govuk-body">
                You'll find it on the right-hand side of the label on your return box. Do not scan the QR code, which is on the left-hand side of the label.
              </p>
              <p class="govuk-body">
                It should look like this:
              </p>
              <div class="govuk-!-margin-top-5">
                <img src="/public/images/royal-mail-barcode.png" class="responsive-image" alt="Illustration of a royal mail barcode showing the position on return box. It is on the right-hand side of the label on your return box."/>
              </div>
              <div class="govuk-form-group">
                <label class="govuk-label" for="mail-barcode-reference-1">
                  Royal Mail barcode reference
                </label>
                <div id="enter-barcode-number-hint-3" class="govuk-hint">
                  For example, ZD 6904 0038 5GB
                </div>
                <input class="govuk-input govuk-!-width-two-thirds" id="mail-barcode-reference-1" name="mail-barcode-reference-1" type="text" value={{ data['mail-barcode-reference-1'] }}>
              </div>
              <div class="govuk-form-group">
                <label class="govuk-label" for="mail-barcode-reference-2">
                  Confirm Royal Mail barcode reference
                </label>
                <input class="govuk-input govuk-!-width-two-thirds" id="mail-barcode-reference-2" name="mail-barcode-reference-2" type="text" value={{ data['mail-barcode-reference-2'] }}>
              </div>
            </fieldset>
          </div>
          <button class="govuk-button" data-module="govuk-button">Continue</button>
          <button id="scan-barcode-2" class="govuk-button govuk-button--secondary" data-module="govuk-button">Use barcode scanner</button>
        </div>

        <p class="govuk-body">
          <a href="/IBT/antigen/feature-design/barcode-scanner/test-kit-barcode" role="button" draggable="false" class="govuk-link" data-module="govuk-button">
            I do not know my Royal Mail barcode
          </a>
        </p>

      </form>

      <div class="gem-c-modal-dialogue" data-module="modal-dialogue" id="modal-window-1" style="display: none;">
        <div class="gem-c-modal-dialogue__overlay"></div>
        <dialog class="gem-c-modal-dialogue__box" aria-modal="true" role="dialog" tabindex="0">
          <div class="gem-c-modal-dialogue__header">
            <svg role="presentation" focusable="false" class="gem-c-modal-dialogue__logotype-crown" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 132 97" height="26" width="30">
              <path fill="currentColor" fill-rule="evenodd" d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"></path>
              <image src="/assets/govuk-logotype-crown-0cdbde943be3a6518a5d7c00b607d134f4d5e3d0e8c68a1bfa2dc81f1f3edc4e.png" class="gem-c-modal-dialogue__logotype-crown-fallback-image"></image>
            </svg>
          </div>    
          <div class="gem-c-modal-dialogue__content">
            <p class="govuk-body"><strong>Camera access needs to be enabled</strong></p>
            <p class="govuk-body">You will need to allow camera permissions to use the scanner.</p>
            <p class="govuk-body">You may need to change the settings on your device.</p>
            <p class="govuk-body">If you wish to scan the Royal Mail barcode, please read the help below the update your settings before you continue</p>
            <p class="body"><a href="#" target="blank">iOS(Apple): how to allow camera access (opens in new tab)</a></p>
          </div>
          <button id="close-button-1" class="gem-c-modal-dialogue__close-button" aria-label="Close modal dialogue">×</button>
        </dialog>
      </div>

      <div class="gem-c-modal-dialogue" data-module="modal-dialogue" id="modal-window-2" style="display: none;">
        <div class="gem-c-modal-dialogue__overlay"></div>
        <dialog class="gem-c-modal-dialogue__box" aria-modal="true" role="dialog" tabindex="0">
          <div class="gem-c-modal-dialogue__header">
            <svg role="presentation" focusable="false" class="gem-c-modal-dialogue__logotype-crown" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 132 97" height="26" width="30">
              <path fill="currentColor" fill-rule="evenodd" d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"></path>
              <image src="/assets/govuk-logotype-crown-0cdbde943be3a6518a5d7c00b607d134f4d5e3d0e8c68a1bfa2dc81f1f3edc4e.png" class="gem-c-modal-dialogue__logotype-crown-fallback-image"></image>
            </svg>
          </div>    
          <div class="gem-c-modal-dialogue__content" id="scanner-wrapper">
            <p class="govuk-body">
              <strong>Scanning will start automatically when the barcode is within the frame</strong>
            </p>
    
            <script src="https://cdn.jsdelivr.net/npm/scandit-sdk@5.x"></script>
    
          </div>
          <button id="close-button-2" class="gem-c-modal-dialogue__close-button" aria-label="Close modal dialogue">×</button>
        </dialog>
      </div>

    </div>
  </div>

  <script type="text/javascript">
    submitEvent()

    const scannerContent = `
    <scandit-barcode-picker
      id="barcodePicker"
      configure.licenseKey="AbZxHhS+NbmiADJfUiuZ2iUaZRoeKa4GCTLu4KFFgGyKH2vUkn0JpCJoyBABajTEH3YqOMsYTH7iWoi+1XBqvjJpT6vbWLs/jEXEg3dhgNQ3UA9ZD0J+8QtrqDinWyRI3XECxE5s9JU1NV9evxgBz9xhH8I9WGbev1mCapBsKk2yYVH33yTlG1tcETWkDzDtbW9mYwh5MyxhcntcwHOFsHwh0zaSHf9bohhSkkQZ5D4xKHAnRhHf5Z7WkHMmCGg5pDu6xTg60YCEZy74vbVdjgg1sBfrxX3mvW/AGytCkn5v4JZ3I1mKqtqCNQxuJTNiecouIIcYdU2Vz3DocNpXGozfmtM/5K6TvrsEeeWYjkA/U8V3CzafMn1xVVdQEvEY0i0elNOtD3TnmrgbF1qv7582IV9kU8JQetxUkj79YLVEJAmAPaxrG4dazuTha6o2El8ElvhvM8U1yN2aXn2LtCfGXZabA0zYCDesH7PzxOlLLYPOr6JIaKPfBK3Gw9VqxrhAYZlPsJoKjEyZkbbisUOY29YFT1AwxrWa49qzETKkUPu0iL2WwzQ4NJnoZs9GFZAeP8V079cKfyI+Q0jPzQglzKmNe7jMepYWDr7jn/sTGb/j+dM/BwSODQQRWiHENrQ2N517Pgob2cP8q33GrBg92OTPcSpI7LB9lI0ZDrfqFX5+cnaFBUn01OU0mYEoU7TPGyHrplUJA0pSUTa+8WvljEpYoNd9qqMtGjc7xP+60/UNix51ZbFFv/tp1vXpUC2IUpWZQHSvgbI6CK6hSBZMwLhWluYIOHM/NicvzIoJlFlMaIVQ/u8HYhM9ZxlNGMf7DyvFswMeiKcqJlrhFISYpi9AHl/Tys6LZ0OKJUCTraR6altiFXc16q/DwGF3uJ6bjbb/uoGGIz/47JVaW+xEVYaXkA=="
      configure.engineLocation="https://cdn.jsdelivr.net/npm/scandit-sdk@5.x/build/"
      playSoundOnScan="true"
      scanSettings.searchArea='{"x":0.1,"y":0.2,"width":0.8,"height":0.6}'
      guiStyle="viewfinder"
      enableTorchToggle="true"
      videoFit="cover"
      scanSettings.enabledSymbologies='["data-matrix", "code128", "qr"]'
      >
    </scandit-barcode-picker>
    `
    const modal1 = document.getElementById('modal-window-1')
    const modal2 = document.getElementById('modal-window-2')
    function removeBarcodePicker() {
      document.getElementById('scanner-wrapper').removeChild(document.getElementById('barcodePicker'))
    } 
    function openBarcodePickerModal() {
      modal1.style.display = 'none'
      modal2.style.display = 'block'
    }
    function openErrorModal() {
      modal1.style.display = 'block'
      modal2.style.display = 'none'
    }
    function closeModals() {
      modal2.style.display = 'none'
      modal1.style.display = 'none'
    }
    function addListener(button, buttonClicked) {
      button.addEventListener('click', function (event) {
        event.preventDefault()
        if (button.getAttribute('disabled') === 'disabled') {
        } else {
          event.preventDefault()
          buttonClicked(button)
        }
      })
    }
  
    function manualEntryButtonClicked(target) {
      setTimeout(function () {
        document.getElementById('content-1').style.display = 'none'
        document.getElementById('content-2').style.display = 'block'
        document.getElementById('mail-barcode-reference-1').focus()
      }, 100)
    }

    function closeButtonClicked(target) {
      setTimeout(function () {
        closeModals()
        document.getElementById('mail-barcode-reference-1').focus()
        removeBarcodePicker()
      }, 100)
    }
  
    function scanButtonClicked(target) {
      navigator.permissions.query({name:'camera'})
    .then(function(permissionStatus) {
      if(permissionStatus.state == "prompt") {
        // console.log('camera permission state is ', permissionStatus.state);
        if(modal2.style.display == 'block') {
          openBarcodePickerModal()
          document.getElementById('scanner-wrapper').innerHTML += scannerContent
        }
      } else {
        // console.log('camera permission state is ', permissionStatus.state);
        if(permissionStatus.state == "granted") {
          openBarcodePickerModal()
          document.getElementById('scanner-wrapper').innerHTML += scannerContent
        } else if(permissionStatus.state == "denied") {
          openErrorModal()
          removeBarcodePicker()
        }
      }

      permissionStatus.onchange = function() {
        // console.log('camera permission state has changed to ', this.state);
        if(this.state == "denied") {
          openErrorModal()
          removeBarcodePicker()
        } else if (this.state == "prompt") {
          closeModals()
          removeBarcodePicker()
        } else {
          openBarcodePickerModal()
          if(document.getElementById('scanner-wrapper').childNodes.length == "2") {
            document.getElementById('scanner-wrapper').innerHTML += scannerContent
          }
        }
      };
    })
    }
  
    function submitEvent() {
      var manualEntryButton = document.getElementById('manual-entry')
      var scanBarcodeButton = document.getElementById('scan-barcode')
      var scanBarcodeButton2 = document.getElementById('scan-barcode-2')
      var closeButton1 = document.getElementById('close-button-1')
      var closeButton2 = document.getElementById('close-button-2')

      addListener(manualEntryButton, manualEntryButtonClicked)
      addListener(scanBarcodeButton, scanButtonClicked)
      addListener(scanBarcodeButton2, scanButtonClicked)
      addListener(closeButton1, closeButtonClicked)
      addListener(closeButton2, closeButtonClicked)
    }

    const barcodePicker = document.getElementById('barcodePicker')
    barcodePicker.addEventListener('scan', function (event) {
      event.preventDefault()
      setTimeout(function () {
        window.location.href = '/IBT/antigen/feature-design/barcode-scanner/test-kit-barcode';
      }, 100)
    })
  
  </script>

{% endblock %}